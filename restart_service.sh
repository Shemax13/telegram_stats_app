#!/bin/bash

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Telegram —Å–µ—Ä–≤–∏—Å–∞..."

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pkill -f "streamlit\|telegram_stats\|telegram_monitor\|run_app.py" 2>/dev/null || true
sleep 2

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üîß –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
source venv/bin/activate

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
python -c "import streamlit, telethon, pandas, plotly; print('‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ OK')" || {
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    pip install telethon python-dotenv streamlit plotly
}

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üöÄ –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
python run_app.py &
MAIN_PID=$!

# –ó–∞–ø—É—Å–∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
echo "üåê –ó–∞–ø—É—Å–∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞..."
streamlit run telegram_stats.py --server.port 8501 --server.address 0.0.0.0 &
WEB_PID=$!

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
echo "1. –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (PID: $MAIN_PID):"
ps -p $MAIN_PID >/dev/null && echo "   ‚úÖ –ó–∞–ø—É—â–µ–Ω–æ" || echo "   ‚ùå –ù–µ –∑–∞–ø—É—â–µ–Ω–æ"

echo "2. –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (PID: $WEB_PID):"
ps -p $WEB_PID >/dev/null && echo "   ‚úÖ –ó–∞–ø—É—â–µ–Ω–æ" || echo "   ‚ùå –ù–µ –∑–∞–ø—É—â–µ–Ω–æ"

echo "3. –í—Å–µ–≥–æ Python –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
ps aux | grep python | grep -v grep | wc -l

echo ""
echo "üéâ –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"
echo "üì± –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:8501"
echo "üîß –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: pkill -f 'streamlit\|telegram_stats\|run_app.py'"